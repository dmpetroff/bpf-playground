# Simple flow-control testing playground


<!-- vim-markdown-toc GFM -->

* [Описание](#Описание)
* [Как пользоваться](#Как-пользоваться)
    * [Задаем локальные параметры](#Задаем-локальные-параметры)
    * [Поднимаем сеть](#Поднимаем-сеть)
    * [Удаление виртуальной сети](#Удаление-виртуальной-сети)
    * [Программа-приемник](#Программа-приемник)
    * [Программа-генератор](#Программа-генератор)
    * [XDP-программа](#xdp-программа)

<!-- vim-markdown-toc -->

# Описание
Утилита для запуска XDP-программе на паре виртуальных интерфейсов.

# Как пользоваться
## Задаем локальные параметры
В `Makefile.local` задаем свое имя корневого файла XDP-программы:
```make
# Makefile.local
XDP_SRC := my-xdp-prog.c
```

При необходимости можно там же поменять IP, имена интерфейсов, сетевого неймспейса и прочее.

## Поднимаем сеть
```bash
make setup
```
Проверяем, что нет конфликта с маршрутами:
```bash
make check-route
```

## Удаление виртуальной сети
```bash
make teardown
```

## Программа-приемник
Программа-приемник `flowrcv/main.go` принимает UDP на заданном порту в сетевом нейспейсе
`$(OUT_NS)` и ежесекундно печатает количество принятых байт (только UDP-payload).
```bash
make run-rcv
```
Должен быть запущен единственный экземпляр приемника.

**ВАЖНО** важно следить за тем, чтобы UDP-пакеты не фрагментировались, что произойдет, если задать
слишком большой размер пакета.

## Программа-генератор
Генератор `flowsnd/main.go` запускает `pv` с заданным параметром rate, а затем, читая его вывод,
разбивает на UDP-пакеты и отправляет на адрес приемника.
```bash
make run-snd
```
Может быть запущено несколько генераторов, однако все они будут иметь один и тот же сетевой адрес.

## XDP-программа
xdp-программа не должна содержать запиненных объектов, т. к. для этого нужно монтировать bpffs
внутри сетевого пространства имен, а это делается не совсем тривиально.

Для загрузки используется утилита `ip` из пакета `iproute2`. Гентушникам не забывать `USE=bpf elf`!
```bash
make run-xdp
```

Чтобы остановить программу, можно выполнить
```bash
make stop-xdp
```
